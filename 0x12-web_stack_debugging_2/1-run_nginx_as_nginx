#!/bin/bash

# Update Nginx configuration to run as nginx user and listen on port 8080
# This script ensures the nginx user exists, modifies nginx configurations,
# and restarts nginx with the new configurations.

# Ensure nginx user exists
if ! getent passwd nginx > /dev/null; then
    echo "Creating nginx user..."
    useradd -r -s /usr/sbin/nologin nginx
fi

# Update nginx.conf to use nginx user
echo "Updating nginx user in nginx.conf..."
NGINX_CONF="/etc/nginx/nginx.conf"
if grep -q "user www-data;" "$NGINX_CONF"; then
    sed -i 's/user www-data;/user nginx;/' "$NGINX_CONF"
elif grep -q "#user nobody;" "$NGINX_CONF"; then
    sed -i 's/#user nobody;/user nginx;/' "$NGINX_CONF"
else
    echo "user nginx;" | cat - "$NGINX_CONF" > temp && mv temp "$NGINX_CONF"
fi

# Update default server block to listen on port 8080
echo "Updating listening port to 8080..."
DEFAULT_SITE="/etc/nginx/sites-available/default"
sed -i 's/listen 80;/listen 8080;/' "$DEFAULT_SITE"
sed -i 's/listen \[::\]:80;/listen [::]:8080;/' "$DEFAULT_SITE"

# Ensure no conflict with Apache
echo "Stopping any running Apache2 service..."
pkill -f apache2 || true

# Restart nginx to apply changes
echo "Restarting nginx..."
nginx -t && systemctl restart nginx

# Confirmation message
echo "Nginx is now configured to run as user 'nginx' and listen on port 8080."




