#!/usr/bin/env bash
# Ensure the script is executed with root privileges
if [ "$(id -u)" -ne 0 ]; then
    echo "This script must be run as root" >&2
    exit 1
fi

# Step 1: Configure Nginx to run as the nginx user
# Check if the nginx user exists, if not, create it
if ! id "nginx" &>/dev/null; then
    useradd -r -s /usr/sbin/nologin nginx
fi

# Update nginx.conf to run as nginx user
NGINX_CONF="/etc/nginx/nginx.conf"
sed -i 's/user www-data;/user nginx;/' $NGINX_CONF

# Step 2: Make nginx listen on port 8080
# Update the default site configuration
DEFAULT_SITE_CONF="/etc/nginx/sites-available/default"
sed -i 's/listen 80 /listen 8080 /' $DEFAULT_SITE_CONF
sed -i 's/listen \[\:\:\]\:80 /listen [::]:8080 /' $DEFAULT_SITE_CONF

# Validate the Nginx configuration
nginx -t

# Step 3: Restart Nginx to apply changes
# Assuming the environment may not use systemd, use nginx command directly
nginx -s reload || nginx

echo "Nginx configuration updated and reloaded."

